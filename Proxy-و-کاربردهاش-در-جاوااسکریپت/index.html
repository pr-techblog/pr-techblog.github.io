<!DOCTYPE html><html><head><title>Proxy و کاربردهاش در جاوااسکریپت</title><meta charset="utf-8" /><meta content='text/html; charset=utf-8' http-equiv='Content-Type'><meta http-equiv='X-UA-Compatible' content='IE=edge'><meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'><meta property="og:locale" content="fa_IR" /><meta property="og:site_name" content="پول ریکوئست" /><meta name="twitter:image" content="/assets/images/pr.svg" /><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="theme-color" content="#000"><meta property="og:type" content="article" /><meta name="description" content="یکی از فیچرهایی که در نسخه ES6 به جاوااسکریپت اضافه شد، کانستراکتور Proxy هست. توی این مطلب باهم در مورد Proxy بیشتر یاد میگیریم وکاربردهایی که میتونه در برنامه نویسی روزانه جاوااسکریپتمون داشته باشه رو باهم بررسی میکنیم. " /><meta property="og:description" content="یکی از فیچرهایی که در نسخه ES6 به جاوااسکریپت اضافه شد، کانستراکتور Proxy هست. توی این مطلب باهم در مورد Proxy بیشتر یاد میگیریم وکاربردهایی که میتونه در برنامه نویسی روزانه جاوااسکریپتمون داشته باشه رو باهم بررسی میکنیم. " /><meta name="twitter:card" content="summary" /><meta name="twitter:description" content="یکی از فیچرهایی که در نسخه ES6 به جاوااسکریپت اضافه شد، کانستراکتور Proxy هست. توی این مطلب باهم در مورد Proxy بیشتر یاد میگیریم وکاربردهایی که میتونه در برنامه نویسی روزانه جاوااسکریپتمون داشته باشه رو باهم بررسی میکنیم. " /><meta name="author" content="پول ریکوئست به قلم farzad" /><meta property="og:title" content="Proxy و کاربردهاش در جاوااسکریپت" /><meta property="twitter:title" content="Proxy و کاربردهاش در جاوااسکریپت" /><link rel="stylesheet" type="text/css" href="/style.css" /><link rel="alternate" type="application/rss+xml" title="پول ریکوئست - پول ریکوئست، دست نوشته های فنی فارسی زبان" href="/feed.xml" /> <script src="/pr.js"></script><body><div class="site__container"><header class="site__header container"><figure class="site__header__brand"> <a href="http://pullrequest.ir"> <img src="/assets/images/pr.svg" alt="PR"> </a></figure><nav class="site__header__nav"><ul class="list--unstyled list--inline header__list text--center"><li> <a href="/about">پول ریکوئست چیست</a><li> <a href="/pr-authors">نویسندگان</a><li> <a href="/contribute">راهنمای انتشار مطالب در پول ریکوئست</a></ul></nav></header><hr class="site__header__divider container" /><main role="main" class="container"><article class="post post--single"><h1 class="post__title post__title--single">Proxy و کاربردهاش در جاوااسکریپت</h1><div class="post__info"> <span> <span class="lazyimage"> <img onload="window.pr.methods.addClass('img-loaded', this.parentNode)" onerror="window.pr.methods.addClass('img-error', this)" src="/assets/images/farzad.jpg" alt="فرزاد یوسف زاده" class="img-rounded post__info__figure inline--middle" > </span> <span class="inline--middle post__author"><a href="http://pullrequest.ir/authors/farzad">فرزاد یوسف زاده</a></span> </span> <small><em>1396-1-19</em></small></div><div class="post__share text--left"><ul class="list--unstyled list--inline"><li><a class="button button--with-icon" target="_blank" href="https://twitter.com/intent/tweet?url=/Proxy-%D9%88-%DA%A9%D8%A7%D8%B1%D8%A8%D8%B1%D8%AF%D9%87%D8%A7%D8%B4-%D8%AF%D8%B1-%D8%AC%D8%A7%D9%88%D8%A7%D8%A7%D8%B3%DA%A9%D8%B1%DB%8C%D9%BE%D8%AA/&via=http://pullrequest.ir&text=Proxy و کاربردهاش در جاوااسکریپت"> <i class="icon pricon-twitter"></i> توییتر </a><li><a class="button button--with-icon" target="_blank" href="https://telegram.me/share/url?url=http://pullrequest.ir/Proxy-%D9%88-%DA%A9%D8%A7%D8%B1%D8%A8%D8%B1%D8%AF%D9%87%D8%A7%D8%B4-%D8%AF%D8%B1-%D8%AC%D8%A7%D9%88%D8%A7%D8%A7%D8%B3%DA%A9%D8%B1%DB%8C%D9%BE%D8%AA/"> <i class="icon pricon-telegram"></i> تلگرام </a></ul><nav class="post__tags post__tags--single"> <i class="icon pricon-tag"></i><ul class="list--unstyled list--inline"><li><a href="/tag/es6">#ES6</a><li><a href="/tag/proxy">#Proxy</a><li><a href="/tag/جاوااسکریپت">#جاوااسکریپت</a><li><a href="/tag/javascript">#Javascript</a></ul></nav></div><div class="post__entry post__entry--single"><p>یکی از فیچرهایی که در نسخه ES6 به جاوااسکریپت اضافه شد، کانستراکتور Proxy هست. توی این مطلب باهم در مورد Proxy بیشتر یاد میگیریم وکاربردهایی که میتونه در برنامه نویسی روزانه جاوااسکریپتمون داشته باشه رو باهم بررسی میکنیم.<p><strong>نکته</strong>: نمونه کدها رو با ES6 نوشتم. برای استفاده ازش توی پروداکشن، حتما با ترنسپایلری مثل <a href="https://babeljs.io/" title="BabelJS" target="_blank">Babel</a> تبدیلش کنید به ES5<h2 id="proxy-چیکار-میکنه">Proxy چیکار میکنه؟</h2><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy" title="تعریف MDN از Proxy" target="_blank">طبق تعریف MDN</a> ، پراکسی بهمون اجازه میده یه آبجکت با اینترفیس خاصی که در ادامه توضیح میدم تعریف کنیم تا به کمکش بتونیم عملکردهای اساسی روی دیتا رو کنترل کنیم. به عبارتی دیگه، میتونیم پیدا کردن یه آیتم توی آبجکت، اضافه کردن آیتم جدید به آبجکت، حذف آیتم از آبجکت و … رو کنترل کنیم و براش یه Middleware بنویسیم.<h2 id="proxy-چطور-کار-میکنه">Proxy چطور کار میکنه؟</h2><p>برای استفاده از Proxy، باید دو پارامتر بهش پاس داده بشه. پارامتر اول آبجکتی هست که میخوایم کنترلش کنیم. یادمون باشه در جاوااسکریپت، Function ها و آرایه ها هم آبجکت محسوب میشن و میشه به عنوان پارامتر اول به Proxy پاسشون داد. پارامتر دوم هندلری هست که طبق متدهاش، کنترلمون روی آبجکت رو پیاده سازی میکنیم.<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">proxy</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Proxy</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span></code></pre></figure><p>هندلری که به عنوان پارامتر دوم پاس داده میشه متدهای زیادی رو قبول میکنه که لیست کاملش رو توی <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy" title="تعریف MDN از Proxy" target="_blank">لینک MDN</a> میتونید ببینید. دومورد از پرکاربردترین متدهای این هندلر (که توی این مطلب باهاشون کار میکنم)، <strong>Set</strong> و <strong>Get</strong> هستن.<p><strong>Set</strong> بهتون اجازه میده فرآیند اضافه شدن آیتم جدید به آبجکت مورد نظر رو کنترل کنید. <strong>Get</strong> بهتون اجازه میده فرآیند خوندن یه آیتم از آبجکت مورد نظر رو کنترل کنید.<h2 id="با-proxy-چه-کارایی-میشه-کرد">با Proxy چه کارایی میشه کرد؟</h2><p>اگر یادتون باشه یه متدی توی جاوااسکریپت به صورت آزمایشی اضافه شده بود به اسم <code class="highlighter-rouge">Object.observe</code> که الان دیگه از رده خارج شده و در اکثر موتورهای رندر جی اس حذف شده اس. کار این متد این بود که تغییرات روی یه آبجکت رو کنترل میکرد. کد زیر رو به عنوان مثال ببینید:<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">foo</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="na">bar</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">changes</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">changes</span><span class="p">);</span>
<span class="p">})</span>

<span class="nx">obj</span><span class="p">.</span><span class="nx">baz</span> <span class="o">=</span> <span class="mi">2</span>
<span class="c1">// [{name: 'baz', object: &lt;obj&gt;, type: 'add'}]</span></code></pre></figure><p>زمانی که تلاش میکردیم تا کلید baz رو به آبجکت obj اضافه کنیم، این فرآیند توسط <code class="highlighter-rouge">Object.observe</code> دیده میشد و یه لاگ نشون میداد از عملیاتی که انجام شده بود.<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[{name: 'baz', object: &lt;obj&gt;, type: 'add'}]
</code></pre></div></div><p>یکی از کارهایی که با Proxy میشه انجام داد Observe کردن آبجکت هاست تا بتونیم زمانی که آیتمی از آبجکت خونده میشه و یا بهش اضافه میشه، مطلعمون کنه.<h2 id="شبیه-سازی-objectobserve-با-استفاده-از-proxy">شبیه سازی Object.observe با استفاده از Proxy</h2><p>برای مشاهده دائمی تغییرات یه آبجکت کافیه یه هندلر با متدهای Set و Get بسازیم و زمانی که عملیات های خوندن و اضافه کردن به آبجکت انجام میشه، اونو توی کنسول نشون بدیم:<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// The object we wanna control</span>
<span class="kd">let</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">// Our handler to control object via Proxy</span>
<span class="kd">const</span> <span class="nx">handler</span> <span class="o">=</span> <span class="p">{</span>
  <span class="kd">get</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Getting property </span><span class="p">${</span><span class="nx">prop</span><span class="p">}</span><span class="s2"> from object`</span><span class="p">)</span>
    <span class="c1">// Remember to so the default operation, returning the prop item inside obj</span>
    <span class="k">return</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span>
  <span class="p">},</span>
  <span class="kd">set</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Setting property </span><span class="p">${</span><span class="nx">prop</span><span class="p">}</span><span class="s2"> as </span><span class="p">${</span><span class="nx">value</span><span class="p">}</span><span class="s2"> in object`</span><span class="p">)</span>

    <span class="c1">// Do the default operation, set prop as value in obj</span>
    <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>

    <span class="cm">/*
      Set method must return a value.
      Return `true` to indicate that assignment succeeded
      Return `false` (even a falsy value) to prevent assignment.in `strict mode`, returning false will throw TypeError
    */</span>

    <span class="k">return</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Set the proxy</span>
<span class="kd">let</span> <span class="nx">proxifiedObj</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Proxy</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>

<span class="c1">// Now to test the handler, Just set some stuff or read props from the obj</span>
<span class="nx">proxifiedObj</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">'Farzad'</span> <span class="c1">// Setting property name as Farzad in object</span>
<span class="nx">proxifiedObj</span><span class="p">.</span><span class="nx">name</span> <span class="c1">// Getting property name from object</span></code></pre></figure><p>همونطور که توی کد بالا مشخصه، یه هندلر ساختیم و برایش متدهای Set و Get نوشتیم. زمانی که یه آبجکت رو پراکسی میکنیم و یه آیتم ازش رو فراخوانی میکنیم مثل <code class="highlighter-rouge">proxifiedObj.name</code>، چون آبجکت <em>proxifiedObj</em> پراکسی شده، مستقیم مقدار <code class="highlighter-rouge">.name</code> خونده نمیشه، بلکه متد <code class="highlighter-rouge">handler.get</code> خونده میشه. که این متد یه لاگ به کنسول انجام میده و اعلام میکنه که چه آیتمی داره خونده میشه و بعدش مقدار این آیتم یعنی <strong>proxifiedObj.name</strong> رو ریترن میکنه.<p>توی متد Set هم نوشتیم، زمانی که میخوایم آیتمی مثل <code class="highlighter-rouge">name</code> رو به آبجکتمون اضافه کنیم، به جای اینکه مستقیما این مقدار بهش اساین بشه، متد <code class="highlighter-rouge">handler.set</code> فراخوانی میشه. این متد هم لاگ میکنه که آیتم فلان با مقدار فلان قراره با آبجکتمون اضافه بشه.<p><strong>نکته</strong>: به کامنتی که در انتهای متد Set نوشتم دقت کنین. متد Set همیشه باید یه مقدار رو ریترن کنه. MDN توی توضیحاتش میگه این مقدار باید ترحیجا Boolean باشه اما در مثال های دیگه میبینیم که فقط کافیه این مقدار Falsy نباشه. امن ترین راه برای حفظ رفتار پیش فرض و اضافه کردن آیتم به آبجکت، <code class="highlighter-rouge">return true</code> هست. اگر هم بخوایم که این اضافه شدن انجام <strong>نشه</strong>، کافیه یه مقدار Falsy ریترن کنیم.<blockquote><p>مقادیر Falsy در جاوااسکریپت: undefined, null, false, 0, ‘‘NaN</blockquote><p>نمونه لایو از کد بالا رو توی کدپن گداشتم تا ببینید:<p data-height="300" data-theme-id="7685" data-slug-hash="YZorLG" data-default-tab="js" data-user="farskid" data-embed-version="2" data-pen-title="Detect Changes in JS Object using ES6 Proxy" class="codepen">See the Pen <a href="http://codepen.io/farskid/pen/YZorLG/">Detect Changes in JS Object using ES6 Proxy</a> by Farzad YZ (<a href="http://codepen.io/farskid">@farskid</a>) on <a href="http://codepen.io">CodePen</a>. <script async="" src="https://production-assets.codepen.io/assets/embed/ei.js"></script><h2 id="deep-freeze-کردن-آبجکت-ها-با-استفاده-از-proxy">Deep Freeze کردن آبجکت ها با استفاده از Proxy</h2><p>یکی دیگه از کارهایی که میشه با Proxy انجام داد، جلوگیری از تغییر یه آبجکت در جاوااسکریپته.یعنی Proxy بهمون اجازه میده Immutable Data بسازیم. درسته که توی نسخه ES6، عبارت Const معرفی شد، اما این عبارت مثل زبان های دیگه که در اونها یه ثابت (Constant) میسازه، عمل نمیکنه. به عبارتی دیگه نباید انتظار داشته باشیم که Const برامون ثابت بسازه. برای اطلاعات بیشتر میتونید به لینک های زیر سر بزنین:<ul><li><a href="https://mathiasbynens.be/notes/es6-const">ES6 const</a><li><a href="https://jack.ofspades.com/es6-const-not-immutable">ES6 const is not immutable</a></ul><p>در مورد <code class="highlighter-rouge">Object.freeze</code> هم ایراد وارده جون فقط یه لول از آبجکت رو فریز میکنه.<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">let</span> <span class="nx">testObj</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">({</span><span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="p">{</span><span class="na">first</span><span class="p">:</span> <span class="s1">'Farzad'</span><span class="p">}})</span>

<span class="nx">testObj</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1">// Would'nt affect the testObj.id</span>
<span class="nx">testObj</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">first</span> <span class="o">=</span> <span class="s1">'Ali'</span> <span class="c1">// Changed testObj</span></code></pre></figure><p>وقتی یه آبجکت Freeze میشه یعنی دیگه نمیشه آیتم های درونش رو عوض کرد. در صورتی که توی اون آبجکت، آبجکت های دیگه ای هم وجود داشته باشن و از تغییر اونا هم جلوگیری کنیم، اسمش میشه Deep Freeze.<p>بریم سراغ کد و یه هندلر بنویسیم. بیایم اسم هندلرمون رو بزاریم rejector، چون تغییراتی که باید روی آبجکتمون رخ بدن رو reject میکنه.<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Create a freeze factory</span>
<span class="kd">const</span> <span class="nx">freezeObjectFactory</span> <span class="o">=</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="c1">// Our handler that rejects any change to the object and any nested objects inside it</span>
  <span class="kd">const</span> <span class="nx">rejector</span> <span class="o">=</span> <span class="p">{</span>
    <span class="kd">get</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>

      <span class="c1">// If dealing with nested object, nest the proxy untill it reaches the direct property of it's parent proxy</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">===</span> <span class="s1">'object'</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="k">new</span> <span class="nb">Proxy</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">],</span> <span class="nx">rejector</span><span class="p">)</span>
      
      <span class="c1">// If prop is directly accessible, just do the default operation</span>
      <span class="k">else</span> <span class="k">return</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span>

    <span class="p">},</span>

    <span class="kd">set</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">rec</span><span class="p">)</span> <span class="p">{</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">`Can not set prop </span><span class="p">${</span><span class="nx">prop</span><span class="p">}</span><span class="s2"> on freezed object`</span><span class="p">)</span>
      
      <span class="c1">// Return the proxy itself.</span>
      <span class="c1">// Note that we could return false, since returning false will create a TypeError, the latter code would always have to be inside a try-catch block which is immpossible and not flexbile.</span>
      <span class="k">return</span> <span class="nx">rec</span>
      
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Now let's use it and put it into test</span>
<span class="c1">// Start our object with default values</span>
<span class="kd">let</span> <span class="nx">testObj</span> <span class="o">=</span> <span class="nx">freezeObjectFactory</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="s1">'Farzad'</span><span class="p">,</span> <span class="na">parent</span><span class="p">:</span> <span class="p">{</span><span class="na">father</span><span class="p">:</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s1">'Ali'</span><span class="p">}}})</span>

<span class="c1">// try to change values</span>
<span class="nx">testObj</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">'John'</span> <span class="c1">// Can not set prop name on freezed object</span>

<span class="nx">testObj</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">father</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">'Mark'</span> <span class="c1">// Can not set prop name on freezed object</span>

<span class="nx">testObj</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">// Can not set prop id on freezed object</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">testObj</span><span class="p">)</span> <span class="c1">// Still the same object as defined above</span></code></pre></figure><p>خب برای اینکه آبجکت هامون رو Freeze کنیم، اولش یه فکتوری ساختم که اگر آبجکتمون رو بهش پاس بدیم، پراکسی شده آبجکتمون رو بهمون میده که دیگه قابل تغییر نیست.<p>متد Get هندلرمون چک میکنه، اگر آیتمی که داریم میخونیمش مستقیم توی خود آبجکت قرار داره همونو بهمون میده. در غیر این صورت به این معنیه که توی یه آبجکت درونی قرار گرفته. ما تنها آبجکت بیرونی رو از پراکسی گذروندیم، یعنی اگر بخوایم آیتم های درونی مثل <code class="highlighter-rouge">testObj.parent.father.name</code> رو ست کنیم دیگه متد Set فراخوانی نمیشه تا جلوی تغییر مقادیر گرفته بشه. پس تا وقتی که با آیتم های تودرتو طرفیم باید اونارو به صورت داخلی از پراکسی بگذرونیم. این توضیح، خط اول متد get رو کامل روشن میکنه.<p>در متد Set هم باید دقت کنیم پارامتر ۴ام این متد همون آبجکتی هست که در ابتدا به پروکسی پاس داده شد یعنی<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{name: 'Farzad', parent: {father: {name: 'Ali'}}}
</code></pre></div></div><p>پس میتونیم همون رو ریترن کنیم. دقت کنید توی کامنت توضیح داده شده که اگر <code class="highlighter-rouge">return false</code> کنیم اونوقت پراکسی <code class="highlighter-rouge">TypeError</code> ریترن میکنه و این یعنی اگر Exception اش گرفته نشه برنامه خط های بعدی رو ادامه نمیده و خارج میشه. این به این معنیه که خط های بعدی باید کلا در یه بلاک try-catch قرار بگیره که غیر ممکن و مسخره اس. پس به جای <code class="highlighter-rouge">return false</code> ما خود آبجکت رو ریترن میکنیم.<p>نمونه کد بالا روی توی کدپن گذاشتم تا راحت تر تستش کنین:<p data-height="300" data-theme-id="7685" data-slug-hash="bqzxRv" data-default-tab="js" data-user="farskid" data-embed-version="2" data-pen-title="Deep Freeze objects using ES6 Proxy" class="codepen">See the Pen <a href="http://codepen.io/farskid/pen/bqzxRv/">Deep Freeze objects using ES6 Proxy</a> by Farzad YZ (<a href="http://codepen.io/farskid">@farskid</a>) on <a href="http://codepen.io">CodePen</a>. <script async="" src="https://production-assets.codepen.io/assets/embed/ei.js"></script><h2 id="ساخت-آبجکت-های-دفاعی-با-استفاده-از-proxy">ساخت آبجکت های دفاعی با استفاده از Proxy</h2><p>آبجکت دفاعی یه تعریف خودساخته اس از آبجکتی که فقط آیتم جدید و غیر تکراری قبول میکنه. در صورتی که بخواین مقدار موجود در آبجکت رو تغییر بدین جلوتون رو میگیره. اما اگر بخواین یه آیتم غیرتکراری جدید بهش اضافه کنین،‌ کاری بهتون نداره.<p>مثلا فرض کنید آبجکتمون <code class="highlighter-rouge">let myObj = {name: 'Farzad', siblings: 1}</code> هست. اگر بخوایم آیتم <code class="highlighter-rouge">siblings</code> رو آپدیت کنیم، جلومون رو میگیره جون siblings وجود داره. اما اگر بخوایم مثلا <code class="highlighter-rouge">myObj.age = 25</code> رو انجام بدیم مشکلی نداره چون age وجود نداره.<p>چون این شرایط خیلی به شرایط قبلی نزدیکه (Deep Freeze)، همون کد رو ویرایش میکنیم.<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Create a defensive factory</span>
<span class="kd">const</span> <span class="nx">defensiveObjectFactory</span> <span class="o">=</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="c1">// Our handler that rejects any change to the object and any nested objects inside it</span>
  <span class="kd">const</span> <span class="nx">rejector</span> <span class="o">=</span> <span class="p">{</span>
    <span class="kd">get</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>

      <span class="c1">// If dealing with nested object, nest the proxy untill it reaches the direct property of it's parent proxy</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">===</span> <span class="s1">'object'</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="k">new</span> <span class="nb">Proxy</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">],</span> <span class="nx">rejector</span><span class="p">)</span>
      
      <span class="c1">// If prop is directly accessible, just do the default operation</span>
      <span class="k">else</span> <span class="k">return</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span>

    <span class="p">},</span>

    <span class="kd">set</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">rec</span><span class="p">)</span> <span class="p">{</span>

      <span class="c1">// This time we traverse the object tree to see whether it contains prop or not</span>
      
      <span class="c1">// If prop is not currently present in obj, add it</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">prop</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>
        <span class="k">return</span> <span class="kc">true</span>
      <span class="p">}</span>

      <span class="c1">// Else warn about it and prevent assignment</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">`Can not set prop </span><span class="p">${</span><span class="nx">prop</span><span class="p">}</span><span class="s2"> on freezed object`</span><span class="p">)</span>
      
      <span class="c1">// Return the proxy itself.</span>
      <span class="c1">// Note that we could return false, since returning false will create a TypeError, the latter code would always have to be inside a try-catch block which is immpossible and not flexbile.</span>
      <span class="k">return</span> <span class="nx">rec</span>
      
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Now let's use it and put it into test</span>
<span class="c1">// Start our object with default values</span>
<span class="kd">let</span> <span class="nx">testObj</span> <span class="o">=</span> <span class="nx">freezeObjectFactory</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="s1">'Farzad'</span><span class="p">,</span> <span class="na">parent</span><span class="p">:</span> <span class="p">{</span><span class="na">father</span><span class="p">:</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s1">'Ali'</span><span class="p">}}})</span>

<span class="c1">// try to change values</span>
<span class="nx">testObj</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">'John'</span> <span class="c1">// Can not set prop name on freezed object</span>

<span class="nx">testObj</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">father</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">'Mark'</span> <span class="c1">// Can not set prop name on freezed object</span>

<span class="nx">testObj</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">// In this case it could be added cause id is new</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">testObj</span><span class="p">)</span> <span class="c1">// not the same object, it has `id` on it</span></code></pre></figure><p>اینبار اول چک میکنیم اگر آیتم درون آبجکت وجود نداشته باشه به آبجکت اضافه میشه مثل <code class="highlighter-rouge">testObj.id</code>. اما جلوی تغییر آیتم های از پیش قرار گرفته مثل <code class="highlighter-rouge">name</code> رو میگیریم.<p>نمونه در کدپن:<p data-height="300" data-theme-id="7685" data-slug-hash="OpemdQ" data-default-tab="js" data-user="farskid" data-embed-version="2" data-pen-title="ES6 Proxy: Protect object properties" class="codepen">See the Pen <a href="http://codepen.io/farskid/pen/OpemdQ/">ES6 Proxy: Protect object properties</a> by Farzad YZ (<a href="http://codepen.io/farskid">@farskid</a>) on <a href="http://codepen.io">CodePen</a>. <script async="" src="https://production-assets.codepen.io/assets/embed/ei.js"></script><h2 id="جمع-بندی">جمع بندی</h2><p>توی این مطلب با Proxy در جاوااسکریپت آشنا شدیم و فهمیدیم که بهمون اجازه میده عملکردهایی مثل خوندن یه آیتم و اضافه کردن آیتم جدید به آبجکت رو کنترل کنیم. درست مثل کاری که Proxy های شبکه ای برامون انجام میدن. کاربردهایی که از Proxy جذاب بودن رو هم با هم مرور کردیم مثل Deep Freeze کردن یه آبجکت یا Defensive کردن آبجکت ها. همینطور یاد گرفتیم که میتونیم تغییرات روی یه آبجکت رو با Proxy ردیابی کنیم و شبیه سازی ای از Object.observe رو بسازیم.<p>اگر از خوندن این مطلب لذت بردین میتونین اونو با دیگران به اشتراک بزارید. همینطور میتونین از سایر مطالب بلاگ هم استفاده کنین و یا اگر دوس داشته باشید، کنارمون بنویسید. برای راهنمای انتشار مطلب در پول ریکوئست میتونین <a href="http://pullrequest.ir/contribute" title="راهنمای انتشار مطلب در پول ریکوئست">از این لینک</a> استفاده کنین.</div><div class="post__share text--center"><ul class="list--unstyled list--inline"><li><a class="button button--with-icon" target="_blank" href="https://twitter.com/intent/tweet?url=/Proxy-%D9%88-%DA%A9%D8%A7%D8%B1%D8%A8%D8%B1%D8%AF%D9%87%D8%A7%D8%B4-%D8%AF%D8%B1-%D8%AC%D8%A7%D9%88%D8%A7%D8%A7%D8%B3%DA%A9%D8%B1%DB%8C%D9%BE%D8%AA/&via=http://pullrequest.ir&text=Proxy و کاربردهاش در جاوااسکریپت"> <i class="icon pricon-twitter"></i> توییتر </a><li><a class="button button--with-icon" target="_blank" href="https://telegram.me/share/url?url=http://pullrequest.ir/Proxy-%D9%88-%DA%A9%D8%A7%D8%B1%D8%A8%D8%B1%D8%AF%D9%87%D8%A7%D8%B4-%D8%AF%D8%B1-%D8%AC%D8%A7%D9%88%D8%A7%D8%A7%D8%B3%DA%A9%D8%B1%DB%8C%D9%BE%D8%AA/"> <i class="icon pricon-telegram"></i> تلگرام </a></ul></div><script> window.pr.methods.docReady(function() { var singleEntry = window.pr.methods.selectElementByClassName('.post__entry--single'); var excerptEntry = window.pr.methods.selectElementByClassName('.post__excerpt'); if (singleEntry) window.pr.methods.parseTextForEmojis(singleEntry); else if (excerptEntry) window.pr.methods.parseTextForEmojis(excerptEntry); }) </script><hr /><div class="comments"><div id="disqus_thread"></div><script async defer src='https://pwl-rykhwyst.disqus.com/embed.js' onerror="disqusHandler();"></script> <script type="text/javascript"> var disqusHandler = (function (w) { var methods = w.pr.methods; /* methods.docReady(function () { loadDisqusScript() }); function loadDisqusScript() { methods.getAjax('https://pwl-rykhwyst.disqus.com/embed.js', null, function (e) { addDisqusErrorIfNotPresent(); // Parse any emoji inside error methods.parseTextForEmojis(document.getElementById('comment__error')); }) } */ function addDisqusErrorIfNotPresent() { var comments = methods.selectElementByClassName('.comments'); /* Add only for the 1st time */ if (!methods.selectElementById('comment__error')) { /* Add error to .comments */ comments.appendChild(createDisqusError()); /* Parse any emoji inside error */ methods.parseTextForEmojis(document.getElementById('comment__error')); } } function createDisqusError() { var err = document.createElement('div'); err.id = 'comment__error'; window.pr.methods.addClass('alert', err); err.innerHTML = 'اگر این پیام رو میبینین، به این معنیه که اسکریپت Disqus براتون لود نشده. سرویس Disqus توی ایران فیلتر شده!! <strong>لطفا وی پی ان تون رو روشن کنین و صفحه فعلی رو ریفرش کنین.</strong> :پی'; return err; } return addDisqusErrorIfNotPresent; })(window); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></article></div><footer class="site__footer clearfix"><div class="site__footer__brand" onclick="window.pr.methods.goToTop()"> <img class="img-block" src="/assets/images/pr.svg" alt="PR"></div><div class="container clearfix"><nav class="pull-right site__footer__menu"><ul class="list--unstyled list--inline site__footer__list"><li> <a target="_blank" href="https://github.com/pr-techblog"> <i class="icon pricon-github"></i> گیتهاب </a><li> <a target="_blank" href="https://twitter.com/pr_techblog"> <i class="icon pricon-twitter"></i> توییتر </a></ul></nav><div class="pull-left text--ltr site__footer__copyright">Made with ❦ @ <strong>PullRequest</strong></div></div></footer></div><script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-93910742-1', 'auto'); ga('send', 'pageview', { 'page': '/Proxy-%D9%88-%DA%A9%D8%A7%D8%B1%D8%A8%D8%B1%D8%AF%D9%87%D8%A7%D8%B4-%D8%AF%D8%B1-%D8%AC%D8%A7%D9%88%D8%A7%D8%A7%D8%B3%DA%A9%D8%B1%DB%8C%D9%BE%D8%AA/', 'title': 'Proxy و کاربردهاش در جاوااسکریپت' }); </script>
