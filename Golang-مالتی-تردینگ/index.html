<!DOCTYPE html><html><head><title>گریزی بر گولنگ goroutines / race condition</title><meta charset="utf-8" /><meta content='text/html; charset=utf-8' http-equiv='Content-Type'><meta http-equiv='X-UA-Compatible' content='IE=edge'><meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'><meta property="og:locale" content="fa_IR" /><meta property="og:site_name" content="پول ریکوئست" /><meta name="twitter:image" content="/assets/images/pr.svg" /><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="theme-color" content="#000"><meta property="og:type" content="article" /><meta name="description" content=" " /><meta property="og:description" content=" " /><meta name="twitter:card" content="summary" /><meta name="twitter:description" content=" " /><meta name="author" content="پول ریکوئست به قلم mahmoud" /><meta property="og:title" content="گریزی بر گولنگ goroutines / race condition" /><meta property="twitter:title" content="گریزی بر گولنگ goroutines / race condition" /><link rel="stylesheet" type="text/css" href="/style.css" /><link rel="alternate" type="application/rss+xml" title="پول ریکوئست - پول ریکوئست، دست نوشته های فنی فارسی زبان" href="/feed.xml" /> <script src="/pr.js"></script><body><div class="site__container"><header class="site__header container"><figure class="site__header__brand"> <a href="http://pullrequest.ir"> <img src="/assets/images/pr.svg" alt="PR"> </a></figure><nav class="site__header__nav"><ul class="list--unstyled list--inline header__list text--center"><li> <a href="/about">پول ریکوئست چیست</a><li> <a href="/pr-authors">نویسندگان</a><li> <a href="/contribute">راهنمای انتشار مطالب در پول ریکوئست</a></ul></nav></header><hr class="site__header__divider container" /><main role="main" class="container"><article class="post post--single"><h1 class="post__title post__title--single">گریزی بر گولنگ goroutines / race condition</h1><div class="post__info"> <span> <span class="lazyimage"> <img onload="window.pr.methods.addClass('img-loaded', this.parentNode)" onerror="window.pr.methods.addClass('img-error', this)" src="/assets/images/mahmoud.jpg" alt="محمود اسکندری" class="img-rounded post__info__figure inline--middle" > </span> <span class="inline--middle post__author"><a href="http://pullrequest.ir/authors/mahmoud">محمود اسکندری</a></span> </span> <small><em>1397-03-13</em></small></div><div class="post__share text--left"><ul class="list--unstyled list--inline"><li><a class="button button--with-icon" target="_blank" href="https://twitter.com/intent/tweet?url=/Golang-%D9%85%D8%A7%D9%84%D8%AA%DB%8C-%D8%AA%D8%B1%D8%AF%DB%8C%D9%86%DA%AF/&via=http://pullrequest.ir&text=گریزی بر گولنگ goroutines / race condition"> <i class="icon pricon-twitter"></i> توییتر </a><li><a class="button button--with-icon" target="_blank" href="https://telegram.me/share/url?url=http://pullrequest.ir/Golang-%D9%85%D8%A7%D9%84%D8%AA%DB%8C-%D8%AA%D8%B1%D8%AF%DB%8C%D9%86%DA%AF/"> <i class="icon pricon-telegram"></i> تلگرام </a></ul><nav class="post__tags post__tags--single"> <i class="icon pricon-tag"></i><ul class="list--unstyled list--inline"><li><a href="/tag/golang">#golang</a><li><a href="/tag/گولنگ">#گولنگ</a><li><a href="/tag/مالتی_تردینگ">#مالتی_تردینگ</a><li><a href="/tag/race_condition">#race_condition</a></ul></nav></div><div class="post__entry post__entry--single"><p><img src="https://files.virgool.io/upload/users/3676/posts/jxcaqbot9swh/hvid0cqa4bve.jpeg" alt="Go" title="Go" /><p>گو روتینها (شبه مالتی تریدینگ) در زبان جالب go یکی از ویژگیهاییه که اون رو محبوب کرده و برای مقاصد زیادی هم کاربرد داره و استفاده ازش هم خیلی راحته در این خُردمقاله فقط اشاره ای مختصر به روتینها میکنم ولی این مبحث خیلی جذابه و جای بحث زیادی داره که از حجم این مقاله و علم بنده بر نمیاد کامل شرح داده بشه. به صورت کلی هرگاه ما یک ترد(نه به معنای ترد در پردازنده که در زبانهای C++ و … پیاده میشه) ایجاد میکنیم دستوراتی که داخل ترد نوشته شده در یک ترد دیگه اجرا خواهد شد که ممکنه همزمان/موازی با ترد اصلیمون اجرا بشوند یا غیر همزمان اجرا بشوند. ساختار نوشتن go به صورت زیره که در تابع main برنامه اجرا میشه ، ( برای نوشتن برنامه های اجرایی mainرو داریم نه همه جا! )<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
 <span class="p">//</span><span class="n">Put</span> <span class="n">your</span> <span class="n">code</span> <span class="n">here</span><span class="p">...</span>
<span class="p">}</span>
<span class="err">اگر</span> <span class="err">عبارت</span> <span class="n">go</span> <span class="err">رو</span> <span class="err">قبل</span> <span class="err">از</span> <span class="err">یک</span> <span class="err">تابع</span> <span class="err">قرار</span> <span class="err">بدیم</span> <span class="err">اون</span> <span class="err">رو</span> <span class="err">در</span> <span class="err">یک</span> <span class="err">ترد</span> <span class="err">جدا</span> <span class="err">اجرا</span> <span class="err">میکنه</span><span class="p">:</span>
<span class="k">package</span> <span class="n">main</span>

<span class="n">import</span> <span class="p">(</span>
 <span class="s2">"fmt"</span>
 <span class="s2">"time"</span>
<span class="p">)</span>

<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">"1:Salam Virgool!"</span><span class="p">)</span>
 <span class="n">go</span> <span class="n">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">"2:Hello Virgool!"</span><span class="p">)</span>
    <span class="p">}()</span>
    <span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">"3:Hola Virgool!"</span><span class="p">)</span>
 
 <span class="p">//</span><span class="nf">Sleep</span> <span class="n">for</span> <span class="n">prevent</span> <span class="n">closing</span>
    <span class="n">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">5000</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div><p>به جای sleep میتونستیم از fmt.Scanln برای جلوگیری از بسته شدن برنامه استفاده کنیم خروجی های متفاوتی برای کد بالا میتونیم انتظار داشته باشیم:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1:Salam Virgool!
3:Hola Virgool!
2:Hello Virgool!
</code></pre></div></div><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1:Salam Virgool!
2:Hello Virgool!
3:Hola Virgool!
</code></pre></div></div><p>پس میتونیتم از این نتیجه بگیریم که اجرای تابع برای چاپ عبارت شماره 2 به ترتیب کدی که نوشتیم ممکنه باشه یا با تاخیر و غیر همزمان باشه! روتینها کجا به کار میان؟ خیلی جاها مثل نوشتن یک روتین برای انجام کارهای زمانبری چون دانلود فایل یا اتصال به شبکه یا اجرای الگوریتمهای زمانبر به طور موازی و انواع و اقسام کار با IO<p>جهنم race conditions چرا جهنم؟ چون باگهایی که به صورت ریس کاندیشن (شرایط مسابقه) پیش میان همیشه یک خطا در روند اجرایی برنامه رو بوجود نمیارن که بتونیم با خوندن چند خط بالا پایین برنامه اونها رو دیباگ کنیم. یعنی یکبار این باگ هست و یکبار نیست ،یا بدتر هر بار یه چیزی نشون بده :( چطور این باگ بوجود میاد؟ به رفتار این تیکه کد دقت کنید:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="n">import</span> <span class="p">(</span>
 <span class="s2">"fmt"</span>
<span class="p">)</span>

<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
 <span class="n">i</span> <span class="p">:=</span> <span class="m">6</span>

 <span class="n">go</span> <span class="n">func</span><span class="p">()</span> <span class="p">{</span>
 <span class="n">i</span> <span class="p">=</span> <span class="n">i</span> <span class="p">+</span> <span class="m">5</span>
    <span class="p">}()</span>
    <span class="n">i</span> <span class="p">*=</span> <span class="m">3</span>
  <span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">"Press Enter:"</span><span class="p">)</span> 
  <span class="n">fmt</span><span class="p">.</span><span class="n">Scanln</span><span class="p">()</span> 
    <span class="n">fmt</span><span class="p">.</span><span class="n">Printf</span><span class="p">(</span><span class="s2">"i = %d </span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div><p>از کد بالا میشه انتظار رفتارهای متفاوتی داشت که اگر چیزی که تو ذهن برنامه نویسه یکی از این رفتار باشه اون موقع است که باگهای بدی بوجود میاد<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(6+5)=11 * 3 = 33 =&gt; i = 33
(6*3)=18 * 5= 23 =&gt; i = 23
(6*3)=18 =&gt; i = 18
</code></pre></div></div><p>حالا چطور اون چیزی که مد نظرمونه در مورد ترتیب روند اجرای دستورات رو اجباری کنیم؟ با استفاده از کانالها Channels ما میتونیم از شرایط و مقادیر یک روتین باخبر بشیم<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="n">import</span> <span class="p">(</span>
 <span class="s2">"fmt"</span>
<span class="p">)</span>

<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
 <span class="n">i</span> <span class="p">:=</span> <span class="m">6</span>

 <span class="n">MyChannel</span> <span class="p">:=</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="n">bool</span><span class="p">)</span>
 <span class="n">go</span> <span class="n">func</span><span class="p">()</span> <span class="p">{</span>
 <span class="n">i</span> <span class="p">=</span> <span class="n">i</span> <span class="p">+</span> <span class="m">5</span>
        <span class="n">MyChannel</span> <span class="p">&lt;-</span> <span class="nb">true</span>
    <span class="p">}()</span>
 <span class="p">//</span><span class="nf">wait</span> <span class="n">for</span> <span class="n">routine</span>
 <span class="p">&lt;-</span><span class="n">MyChannel</span>
    <span class="n">i</span> <span class="p">*=</span> <span class="m">3</span>
    <span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">"Press Enter:"</span><span class="p">)</span>
    <span class="n">fmt</span><span class="p">.</span><span class="n">Scanln</span><span class="p">()</span>
    <span class="n">fmt</span><span class="p">.</span><span class="n">Printf</span><span class="p">(</span><span class="s2">"i = %d </span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div><p>میایم قبل از اجرای روتین یک کانال به نام MyChannel میسازیم و بعدش منتظر میمونیم که اون تموم بشه و کار رو ترد اصلی انجام بده که نتیجه همیشه 33 خواهد شد چون به ترتیب عبارت اولمون (6+5)=11 * 3 = 33 =&gt; i = 33 برنامه اجرا میشه!<p>ساده بود نه؟ :)</div><div class="post__share text--center"><ul class="list--unstyled list--inline"><li><a class="button button--with-icon" target="_blank" href="https://twitter.com/intent/tweet?url=/Golang-%D9%85%D8%A7%D9%84%D8%AA%DB%8C-%D8%AA%D8%B1%D8%AF%DB%8C%D9%86%DA%AF/&via=http://pullrequest.ir&text=گریزی بر گولنگ goroutines / race condition"> <i class="icon pricon-twitter"></i> توییتر </a><li><a class="button button--with-icon" target="_blank" href="https://telegram.me/share/url?url=http://pullrequest.ir/Golang-%D9%85%D8%A7%D9%84%D8%AA%DB%8C-%D8%AA%D8%B1%D8%AF%DB%8C%D9%86%DA%AF/"> <i class="icon pricon-telegram"></i> تلگرام </a></ul></div><script> window.pr.methods.docReady(function() { var singleEntry = window.pr.methods.selectElementByClassName('.post__entry--single'); var excerptEntry = window.pr.methods.selectElementByClassName('.post__excerpt'); if (singleEntry) window.pr.methods.parseTextForEmojis(singleEntry); else if (excerptEntry) window.pr.methods.parseTextForEmojis(excerptEntry); }) </script><hr /><div class="comments"><div id="disqus_thread"></div><script async defer src='https://pwl-rykhwyst.disqus.com/embed.js' onerror="disqusHandler();"></script> <script type="text/javascript"> var disqusHandler = (function (w) { var methods = w.pr.methods; /* methods.docReady(function () { loadDisqusScript() }); function loadDisqusScript() { methods.getAjax('https://pwl-rykhwyst.disqus.com/embed.js', null, function (e) { addDisqusErrorIfNotPresent(); // Parse any emoji inside error methods.parseTextForEmojis(document.getElementById('comment__error')); }) } */ function addDisqusErrorIfNotPresent() { var comments = methods.selectElementByClassName('.comments'); /* Add only for the 1st time */ if (!methods.selectElementById('comment__error')) { /* Add error to .comments */ comments.appendChild(createDisqusError()); /* Parse any emoji inside error */ methods.parseTextForEmojis(document.getElementById('comment__error')); } } function createDisqusError() { var err = document.createElement('div'); err.id = 'comment__error'; window.pr.methods.addClass('alert', err); err.innerHTML = 'اگر این پیام رو میبینین، به این معنیه که اسکریپت Disqus براتون لود نشده. سرویس Disqus توی ایران فیلتر شده!! <strong>لطفا وی پی ان تون رو روشن کنین و صفحه فعلی رو ریفرش کنین.</strong> :پی'; return err; } return addDisqusErrorIfNotPresent; })(window); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></article></div><footer class="site__footer clearfix"><div class="site__footer__brand" onclick="window.pr.methods.goToTop()"> <img class="img-block" src="/assets/images/pr.svg" alt="PR"></div><div class="container clearfix"><nav class="pull-right site__footer__menu"><ul class="list--unstyled list--inline site__footer__list"><li> <a target="_blank" href="https://github.com/pr-techblog"> <i class="icon pricon-github"></i> گیتهاب </a><li> <a target="_blank" href="https://twitter.com/pr_techblog"> <i class="icon pricon-twitter"></i> توییتر </a></ul></nav><div class="pull-left text--ltr site__footer__copyright">Made with ❦ @ <strong>PullRequest</strong></div></div></footer></div><script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-93910742-1', 'auto'); ga('send', 'pageview', { 'page': '/Golang-%D9%85%D8%A7%D9%84%D8%AA%DB%8C-%D8%AA%D8%B1%D8%AF%DB%8C%D9%86%DA%AF/', 'title': 'گریزی بر گولنگ goroutines / race condition' }); </script>
