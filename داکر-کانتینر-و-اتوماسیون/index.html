<!DOCTYPE html><html><head><title>داکر، داکر کامپز، کانتینرها و اتوماسیون</title><meta charset="utf-8" /><meta content='text/html; charset=utf-8' http-equiv='Content-Type'><meta http-equiv='X-UA-Compatible' content='IE=edge'><meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'><meta property="og:locale" content="fa_IR" /><meta property="og:site_name" content="پول ریکوئست" /><meta name="twitter:image" content="/assets/images/pr.svg" /><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="theme-color" content="#000"><meta property="og:type" content="article" /><meta name="description" content="داکر چی هست؟ داکر کامپز چیکار میکنه و چجوری میتونیم پروژمون رو اتوماسیون کنیم؟ " /><meta property="og:description" content="داکر چی هست؟ داکر کامپز چیکار میکنه و چجوری میتونیم پروژمون رو اتوماسیون کنیم؟ " /><meta name="twitter:card" content="summary" /><meta name="twitter:description" content="داکر چی هست؟ داکر کامپز چیکار میکنه و چجوری میتونیم پروژمون رو اتوماسیون کنیم؟ " /><meta name="author" content="پول ریکوئست به قلم aien" /><meta property="og:title" content="داکر، داکر کامپز، کانتینرها و اتوماسیون" /><meta property="twitter:title" content="داکر، داکر کامپز، کانتینرها و اتوماسیون" /><link rel="stylesheet" type="text/css" href="/style.css" /><link rel="alternate" type="application/rss+xml" title="پول ریکوئست - پول ریکوئست، دست نوشته های فنی فارسی زبان" href="/feed.xml" /> <script src="/pr.js"></script><body><div class="site__container"><header class="site__header container"><figure class="site__header__brand"> <a href="http://pullrequest.ir"> <img src="/assets/images/pr.svg" alt="PR"> </a></figure><nav class="site__header__nav"><ul class="list--unstyled list--inline header__list text--center"><li> <a href="/about">پول ریکوئست چیست</a><li> <a href="/pr-authors">نویسندگان</a><li> <a href="/contribute">راهنمای انتشار مطالب در پول ریکوئست</a></ul></nav></header><hr class="site__header__divider container" /><main role="main" class="container"><article class="post post--single"><h1 class="post__title post__title--single">داکر، داکر کامپز، کانتینرها و اتوماسیون</h1><div class="post__info"> <span> <span class="lazyimage"> <img onload="window.pr.methods.addClass('img-loaded', this.parentNode)" onerror="window.pr.methods.addClass('img-error', this)" src="/assets/images/aien.jpg" alt="آیین سعیدی" class="img-rounded post__info__figure inline--middle" > </span> <span class="inline--middle post__author"><a href="http://pullrequest.ir/authors/aientech">آیین سعیدی</a></span> </span> <small><em>1397-05-01</em></small></div><div class="post__share text--left"><ul class="list--unstyled list--inline"><li><a class="button button--with-icon" target="_blank" href="https://twitter.com/intent/tweet?url=/%D8%AF%D8%A7%DA%A9%D8%B1-%DA%A9%D8%A7%D9%86%D8%AA%DB%8C%D9%86%D8%B1-%D9%88-%D8%A7%D8%AA%D9%88%D9%85%D8%A7%D8%B3%DB%8C%D9%88%D9%86/&via=http://pullrequest.ir&text=داکر، داکر کامپز، کانتینرها و اتوماسیون"> <i class="icon pricon-twitter"></i> توییتر </a><li><a class="button button--with-icon" target="_blank" href="https://telegram.me/share/url?url=http://pullrequest.ir/%D8%AF%D8%A7%DA%A9%D8%B1-%DA%A9%D8%A7%D9%86%D8%AA%DB%8C%D9%86%D8%B1-%D9%88-%D8%A7%D8%AA%D9%88%D9%85%D8%A7%D8%B3%DB%8C%D9%88%D9%86/"> <i class="icon pricon-telegram"></i> تلگرام </a></ul><nav class="post__tags post__tags--single"> <i class="icon pricon-tag"></i><ul class="list--unstyled list--inline"><li><a href="/tag/docker">#docker</a><li><a href="/tag/docker-compose">#docker-compose</a><li><a href="/tag/container">#container</a><li><a href="/tag/javascript">#javascript</a><li><a href="/tag/automation">#automation</a></ul></nav></div><div class="post__entry post__entry--single"><p>داکر چی هست؟ داکر کامپز چیکار میکنه و چجوری میتونیم پروژمون رو اتوماسیون کنیم؟<h1 id="داکر-کانتینر-و-اتوماسیون">داکر، کانتینر و اتوماسیون</h1><p><img src="https://files.virgool.io/upload/users/3181/posts/b1mi525hzvoe/1p7yoldghfgz.png" alt="" /><h1 id="مقدمه">مقدمه</h1><p>بالاخره بعد از یه مدت طولانی که از داون شدن سایتم میگذره، تونستم دوباره وصلش کنم و کانفیگای سمت سرور رو دوباره فیکس کنم. شاید جالب باشه ولی سرور من جای خلوتیه و چیز زیادی توش نیست و وب‌سایت خودم تنها برنامه‌ایه که توش اجرا میشه، اما نکته‌ی جالب اینه که موقع دیپلوی باهاش خیلی مشکل دارم. بگذریم، همین مشکلات باعث شد که به نوشتن این مطلب فکر کنم و تا جایی که میتونم در مورد داکر توضیح بدم.<p>خواهش من مثل همیشه، انه که ان مطلب رو بخونید، ازش لذت ببرید و برای دوستاتون هم بفرستید و اگر جایی اشکالی دیدید، بهم خبر بدید. ضمنا، حقوق نویسنده رو هم فراموش نکنید و اگر جایی از این مطلب استفاده میکنید، اسم نویسنده اصلی (من، آیین) رو توش درج کنید.<p>سپاس<h1 id="داکر-docker-چی-هست">داکر (Docker) چی هست؟</h1><p>اول از همه، داکر اسم شرکتی هست که واژه کانتِینِر یا Container رو روانه‌ی دنیای آی‌تی کرده. البته که قبلا هم از این واژه استفاده‌های گسترده‌ای میشده، اما داکر باعث شده که واژه کانتِینِر معنی مشخص‌تر و دقیق‌تری پیدا کنه.<p>خود نرم‌افزار داکر، یه سرویس برای مدیریت کانتینرها یا Container Service Manager هست. کلیدواژه‌هایی که میشه برای داکر استفاده کرد، <strong>توسعه‌دادن، دیپلوی کردن و اجرا کردن</strong> هستن. در واقع داکر هدفش اینه که وقتی برنامه‌نویس‌ها، نرم‌افزاری رو می‌نویسن، اون رو به کانتینرها منتقل و به سادگی اون رو هر جایی اجرا کنن.<h2 id="پلتفرم-سَکو-کانتینر-چی-هست">پلتفرم (سَکو؟!) کانتینر چی هست؟</h2><p>پلتفرم کانتینر یا Container Platform یه سرویس کامل برای سازمان‌ها و شرکت‌هاست که بتونن باهاش مشکلات مختلفی رو حل کنن. مهمترین ویژگی کانتینرها اینه که تمام نرم‌افزارهایی که برنامه لازم داره رو، توی خودشون نگه‌میدارن. اما یکم در مورد کانتینرها عمیق بشم…<p>کانتینر یه پراسِس (Process) داکر هست که فقط روی لینوکس یا ویندوز اجرا میشه (ظاهرا برای مک هم هست ولی من جایی ندیدم) و داخل خودش هرچیزی که برای اجرا شدن نیاز داشته‌باشه رو داره. در واقع یه کانتینر <strong>یکمی شبیه به ماشین‌مجازی یا Virtual Machine هست</strong> با این تفاوت که <strong>هسته‌ی سیستم‌عامل میزبان یا Host رو به اشتراک میذاره.</strong><p><img src="https://files.virgool.io/upload/users/3181/posts/b1mi525hzvoe/nyajlhjigsvr.jpeg" alt="" /><p>عکس بالا، اساسی‌ترین تفاوت کانتینرها با ماشین‌های مجازی رو نشون میده. چارت سمت راست کانتینر و سمت چپ، ماشین مجازی. زیر ساخت‌ها یا Infrastructures شبیه به هم، داکر از سیستم‌عامل میزبان و ماشین مجازی از Hypervisor که یه لایه هست تا برنامه‌های مورد نیاز سیستم‌عامل داخل ماشین رو فراهم کنه، استفاده میکنه. تو ماشین مجازی شما به یه سیستم‌عامل مهمان احتیاج دارید، مثلا توی سیستم‌عامل لینوکستون، ویندوز نصب میکنید، اما داکر اینطور نیست و از موتور خودش استفاده میکنه تا با سیستم‌عامل میزبان ارتباط برقرار کنه. تو ماشین مجازی شما سیستم‌عامل رو نصب میکنید که برنامه‌های لازم رو بتونید فراهم کنید. این قدم تو کانتینر از بین رفته (و دقیقا چیزیه که سرعت کانتینر رو به نسبت ماشین‌مجازی خیلی بیشتر می‌کنه). در نهایت کتابخونه‌ها و برنامه‌های لازم اجرا میشن و شما میتونید سیستمتون رو بالا بیارید.<p>این رو اضافه میکنم، فرض کنید داکر همون نرم‌افزار Oracle VirtualBox یا VMWare هست و کانتینرها، همون سیستم‌عامل‌هایی که توشون نصب می‌کنیم.<h1 id="containerization-vs-virtualization">Containerization vs Virtualization</h1><p>قبل از اینکه وارد این مبحث بشم، یه نگاهی به ترمینولوژی داکر داشته باشیم:<p>موتور داکر یا <strong>Docker Engine</strong>قسمتی از داکر که وظیفه‌ی ایجاد و اجرای کانتینرها رو دارههاب داکر یا <strong>Docker Hub</strong>سرویسی از داکر برای به اشتراک‌گذاری کانتینرها با دیگرانداکر کامپوز یا <strong>Docker Compose</strong><p>ابزاری که باهاش برنامه‌های چند کانتینری تعریف میکنیم. این ابزار از فایلهای Yaml استفاده میکنه تا فایل‌ها و تنظیمات رو کانفیگ کنه و کانتینر رو آماده اجرا کنه.<p>در کل استفاده از این ابزار سه مرحله داره:<ol><li>محیط برنامه رو با یه Dockerfile تعریف میکنیم تا همه‌جا بشه ازش استفاده کرد.<li>سرویس‌هایی که لازم هست برای اجرای این کانتینر رو تو فایل docker-compose.yml میذاریم تا با فایل Dockerfile یه جا اجرا بشن.<li>دستور docker-compuse up رو اجرا میکنیم و تموم میشه!</ol><p>داکر ایمِج یا <strong>Docker Image</strong><p>تو داکر، همه‌چیز بر اساس ایمِج‌ها ساخته شده!<p>داکر فایل یا <strong>Docker file</strong>دستوراتی که برای ساخت ایمِج لازم هست اینجا تعریف میشه.<h2 id="حالا-کانتِینِریزِیشن-در-مقابل-ویرچوالیزِیشن-یا-مجازیسازی-چی-هست">حالا کانتِینِریزِیشن در مقابل ویرچوالیزِیشن یا مجازی‌سازی چی هست؟</h2><p>هرچه‌قدر که زمان میگذره، تکنولوژی داکر بین حرفه‌ای‌های IT محبوبیت بیشتری پیدا می‌کنه، که باعث میشه برای برنامه‌نویس‌ها دونستن حداقل مبانی کانتینر‌ها به یک «باید» تبدیل بشه.<p>صنعت IT هرروز درحال تغییر و پیشرفته و «سرعت و بهینه‌سازی» تبدیل به اساس این صنعت شدن. تکنولوژی‌ها سعی کردن روش‌های بهتری رو برای اتوماسیون ارائه بدن تا پروسه ساخت و تولید برنامه‌ها روراحتتر و سریع‌تر کنن.<p>نمیدونم که آیا با Industry 4.0 آشنایی دارید یا نه، اما مجازی‌سازی یا ویرچوالیزیشن (Virtualization) سعی کرده تا این نسخه از صنعت IT رو بهینه‌تر و قابل‌حمل‌تر یا Portable کنه. با این‌حال، تکنولوژی مجازی‌سازی نقاط ضعف جدی رو داره، مثل کاهش محسوس پرفورمنس نرم‌افزارها که بخاطر وزن زیاد و ساختار سنگین VMها یا Virtual Machineها اتفاق میوفته. یا مثلا غیرقابل حمل بودن برنامه‌ها و کارایی پایین در مدیریت منابع سیستم و چیزهای دیگه از این دسته.<p>اینجاست که صنعت IT رفته سراغ تکنولوژی داکر و کانتینریزیشن! دقیق‌تر میگم، موتور داکر برای کانتینریزیشن ساخته شده که مراحل <strong>بسته‌بندی، حمل و گسترش</strong> برنامه‌ها رو بسیار ساده کرده.<h1 id="شکافت-هستهی-اتم">شکافت هسته‌ی اتم!</h1><p>برای یادگیری و راه‌اندازی داکر، نیازی نیست فیزیک کوانتوم بلد باشید یا بتونید حداقل یکی از <a href="https://curiosity.com/topics/the-millennium-problems-are-seven-math-problems-worth-dollar1-million-each-curiosity/">سوالای میلنیوم ریاضی</a> رو حل کنید! فقط کافیه یکمی با محیط ترمینال و cli دوست باشید و یک تکست‌ادیتور هم کنار دستتون باشه، و خب قطعا داشتن یکمی دانش برنامه‌نویسی هم میتونه به کارتون بیاد!<h2 id="نصب-و-راهاندازی-داکر">نصب و راه‌اندازی داکر</h2><p>گرفتن تمام ابزارهای مورد نیازتون برای داکر میتونه کمی خسته‌کننده به نظر برسه. اما توصیه‌ی من اینه که قبل از نصب داکر، حتما <a href="https://code.visualstudio.com/">نرم‌افزار vscode رو دانلود کنید</a> و در نهایت <a href="https://www.docker.com/community-edition#/linux">داکر رو برای سیستم‌عامل خودتون دریافت کنید.</a><p>بعد از نصب داکر، دستور زیر رو اجرا کنید تا مطمئن بشیم همه‌چیز درست انجام شده:<p><code class="highlighter-rouge">$ docker run hello-world</code><p>که در پاسخش باید نتیجه‌ی زیر رو دریافت کنید:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hello from Docker.
This message shows that your installation appears to be working correctly.
...
</code></pre></div></div><h2 id="بازی-با-busybox">بازی با BusyBox</h2><p>حالا که داکر نصب شده، بریم و یکم دستامون رو کثیف کنیم. برای اینکار یه کانتینر BusyBox (یه نرم‌افزار که یسری از ابزارهای Unix رو توی یه فایل به شما میده) رو نصب میکنیم تا طعم دستور <code class="highlighter-rouge">docker run</code> رو بچشیم.<p>برای شروع، دستور زیر رو اجرا کنید:<p><code class="highlighter-rouge">$ docker pull busybox</code><p>دقت داشته باشید که ممکن هست به ارور <code class="highlighter-rouge">permission denied</code> برخورد کنید. بهترین راه اینه که خودتون رو توی گروه docker اضافه کنید تا ازش پیشگری بشه.<p>دستور <code class="highlighter-rouge">pull</code> ایمِج BusyBox رو از <a href="https://hub.docker.com/explore/">رجیستری داکر (Docker Registry) یا همون داکرهاب (Docker Hub)</a> دریافت و اون روی روی سیستممون ذخیره میکنه. ضمنا شما میتونید دستور <code class="highlighter-rouge">docker images</code> رو اجرا کنید تا ببینید چه ایمِج‌هایی روی سیستمتون نصب شدن.<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REPOSITORY                           TAG                 IMAGE ID            CREATED             SIZE
nexus.ida-analytics.de/ida/moira     latest              e3503776559a        6 days ago          387MB
nexus.ida-analytics.de/ida/grafana   latest              a1192aa71c7f        7 days ago          387MB
nexus.ida-analytics.de/ida/grafana                 6145fb02ee49        7 days ago          387MB
nexus.ida-analytics.de/ida/moira                   1323d422a434        7 days ago          387MB
busybox                              latest              8c811b4aec35        7 weeks ago         1.15MB 
</code></pre></div></div><h2 id="docker-run">Docker Run</h2><p>عالی شد! حالا وقتش شده که یه کانتینر داکر، مبتنی بر ایمِجی که گرفتیم رو اجرا کنیم. برای اینکار از دستور زیر استفاده میکنیم:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker run busybox
$
</code></pre></div></div><p>چی شد؟! چرا هیچ اتفاقی رخ نداد؟! خب، واقعیت اینه که کلی اتفاقات اینجا افتاده که با چشم غیر مسلح قابل رویت نیست :دی. وقتی که شما دستور <code class="highlighter-rouge">run</code> رو صدا میزنید، داکر ایمِجی که گفتید رو پیدا میکنه (اینجا میشه Busybox)، یه کانتینر براش میسازه و یه دستور رو توی کانتینر اجرا میکنه. اگر دقت کنید، تو دستور <code class="highlighter-rouge">docker run busybox</code> ما هیچ دستور اضافی رو فراهم نکردیم. بنابراین کانتینر ساخته شده، بالا اومده، یه دستور خالی رو اجرا کرده و خارج شده.<p>دستور بالا رو میشه اینطور هم نوشت:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker run busybox echo "Salam Donya!!"
Salam Donya!!
</code></pre></div></div><p>اینجا داکر، دستور echo رو اجرا کرده و در نهایت بسته شده. حالا فکر کنید میخواستید همه‌ی اینا رو با ماشین‌مجازی اجرا کنید! چقدر باید صبر می‌کردید؟<p>حالا وقتش شده که دستور <code class="highlighter-rouge">docker ps</code> رو اجرا کنیم.<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
</code></pre></div></div><p>از اونجایی که هیچ کانتینری در حال اجرا نیست، ما هم یه لیست خالی رو دریافت کردیم. حالا یکم دستور رو دقیق‌تر میکنیم:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker ps -a
CONTAINER ID        IMAGE                                       COMMAND                CREATED             STATUS                      PORTS               NAMES
2059d101f971        busybox                                     "echo Hallo"           15 minutes ago      Exited (0) 15 minutes ago                       hopeful_nightingale
45f36d883bd4        busybox                                     "sh"                   15 minutes ago      Exited (0) 15 minutes ago                       kind_mcnulty
375b34dfa64c        nexus.ida-analytics.de/ida/moira:latest     "/bin/moira"           6 days ago          Exited (137) 6 days ago                         moira
45ba50ce36f9        nexus.ida-analytics.de/ida/grafana:latest   "/bin/start_grafana"   6 days ago          Exited (0) 6 days ago                           grafana
</code></pre></div></div><p>همون‌طور که مشخصه، پارامتر <code class="highlighter-rouge">-a</code> دستور داده که لیست تمام کانتینرها، فاقد از وضعیتشون (که اینجا <code class="highlighter-rouge">exited</code> هست) برگردونده بشه.<p>شاید براتون سوال بشه که چطور میشه دستورات بیشتری رو توی کانتینر اجرا کرد؟ خیلی آسون. اگر با دستور <code class="highlighter-rouge">ssh</code> آشنایی داشته باشید، میخوایم اینجا یه کاری مشابه اون رو انجام بدیم:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker run -it busybox sh
/ # ls
bin   dev   etc   home  proc  root  sys   tmp   usr   var
/ # pwd
/
/ # uptime
 22:30:58 up  3:26,  0 users,  load average: 1.54, 1.46, 1.48
/ #
</code></pre></div></div><p>اجرا کردن دستور <code class="highlighter-rouge">run</code> با پارامتر <code class="highlighter-rouge">-it</code> باعث میشه که ما به داخل کانتینر (در واقع با ساخت یه سِشِن tty) بریم و دستوراتی که میخوایم رو اونجا اجرا کنیم.<p>قبل از اینکه به مرحله‌ی بعدی برم، بهتون این نکته رو هم میگم که چطور میشه کانتینرها رو حذف کرد. بالاتر دیدیم که با اجرا کردن دستور <code class="highlighter-rouge">docker ps -a</code> میتونیم لیست تمام کانتینرهامون رو بدست بیاریم. برای حذف یه کانتینر کافیه که <code class="highlighter-rouge">CONTAINER ID</code> او کانتینر رو برداریم و بعد دستور <code class="highlighter-rouge">docker rm CONTAINER_ID</code> رو اجرا کنیم. که در پاسخش باید آی‌دی کانتینر دوباره به شما نمایش داده بشه.<p>دستور زیر هم هست:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker rm $(docker ps -a -q -f status=exited)
</code></pre></div></div><p>اجرا کردن این دستور، تمام کانتینرهایی که وضعیت <code class="highlighter-rouge">exited</code> دارن رو پاک میکنه.<h1 id="وباَپ-تو-داکر">وب‌اَپ تو داکر</h1><p>تا اینجا فهمیدیم که دستور <code class="highlighter-rouge">docker run</code> تا حدودی چطور کار میکنه، همزمان یکمی هم با کانتینرها بازی کردیم و با ترمینولوژی داکر بیشتر آشنا شدیم. حالا وقتش شده که بریم سراغ مسائل اساسی، و ببینیم که چطور میشه یه وب‌اَپ رو تو داکر دیپلوی یا Deploy کرد.<h2 id="سایتهای-استاتیک">سایت‌های استاتیک</h2><p>بذارید قدم‌های کوچک برداریم. اولین چیزی که میریم سراغش، دیپلوی کردن یه سایت استاتیک خیلی ساده هست. یه ایمِج رو از داکر‌هاب دریافت یا pull میکنیم و اجراش میکنیم تا ببینیم چقدر راه‌اندازی سایت‌های استاتیک کار آسونیه.<p>ایمِجی که برای اینکار استفاده میکنیم، یه ایمِج از قبل آماده شدست:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker run prakhar1989/static-site
</code></pre></div></div><p>از اونجایی که این ایمِج به صورت لوکال یا محلی تو سیستم ما نیست، داکر اون رو از رجیستری دریافت میکنه و بعد ایمِج رو اجرا میکنه. اگر همه‌چیز خوب پیش بره، شما پیام <code class="highlighter-rouge">Nginx is running...</code> رو خواهید دید. حالا که سرور راه‌افتاده، چطور میشه بهش دسترسی داشت؟ چطوری میشه فهمید تو چه پورتی اجرا شده؟<p>خب تو این حالت، داکر هیچ پورتی رو نمایش یا اصطلاحا اِکسپوز (Expose) نمیکنه، برای همین لازم هست که مجددا دستور <code class="highlighter-rouge">docker run</code> رو اجرا کنیم تا پورت‌ها رو نمایش بدیم. همزمان هم باید کاری کنیم که ترمینال روی این حالت قفل نشه و ما بتونیم از ترمینال، بدون بستن سرور خارج بشیم. به این حالت میگن Detached Mode یا حالت جدا شده!<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker run -d -P --name static-site prakhar1989/static-site
531b38e65151ba7ee133aff085d4c3e31d9ab349d0fed2b48b91cf28d53ca685
</code></pre></div></div><p>تو دستور بالا، <code class="highlighter-rouge">-d</code> حالت detached mode رو اجرا و <code class="highlighter-rouge">-P</code> پورت‌هارو باز میکنه. <code class="highlighter-rouge">--name</code> هم اسمی رو برای کانتینر درنظر میگیره. حالا میتونیم پورت‌های باز شده رو پیدا کنیم:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker port static-site
443/tcp -&gt; 0.0.0.0:32768
80/tcp -&gt; 0.0.0.0:32769
</code></pre></div></div><p>حالا، <a href="http://localhost:32769/">http://localhost:32769</a> رو باز کنید و نتیجه رو ببینید.<p>همچنین میتونید یه آدرس پورت دلخواه هم به ایمِجتون بدید:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker run -p 8888:80 prakhar1989/static-site
Nginx is running...
</code></pre></div></div><p>این دستور میگه که: به پورت ۸۸۸۸ سیستم هاست یا میزبان، هرچیزی که تو پورت ۸۰ ایمِج بود رو اختصاص بده. برای اینکه کانتینر رو متوقف کنید، دستور <code class="highlighter-rouge">docker stop</code> رو به همراه آی‌دی کانتینر اجرا کنید.<p>مطمئن هستم که شما هم موافقید این کار واقعا آسون بود! فکر کنید شما یه سرور دارید و میخواید سایتتون رو روش راه‌اندازی کنید، کل کار اینه که داکر رو نصب کنید و دستورات بالا رو وارد کنید!<p>ولی خب، این برای ما کافی نیست، چون ما دوست داریم بیشتر بدونیم :) برای همین باید یاد بگیریم چطور داکر ایمِج خودمون رو بسازیم…<h2 id="داکر-ایمِجها">داکر ایمِج‌ها</h2><p>ما با ایمِج‌ها تا حدودی آشنا شدیم، ولی تو این بخش میخوام عمیق‌تر شیرجه‌ بزنیم تو ایمِج‌ها و ببینیم اصلا ایمِج‌های داکر چی هستن… کاری که انجام دادیم این بود که ایمِج busybox رو از رجیستری <strong>دریافت یا pull کردیم،</strong> و به داکر گفتیم که یه کانتینر <strong>مبتنی بر اون ایمِج</strong> برامون بسازه. اول بیاید یه لیستی از ایمِج‌هامون رو بگیریم:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker images
REPOSITORY                           TAG                 IMAGE ID            CREATED             SIZE
nexus.ida-analytics.de/ida/moira     latest              e3503776559a        7 days ago          387MB
nexus.ida-analytics.de/ida/grafana   latest              a1192aa71c7f        7 days ago          387MB
nexus.ida-analytics.de/ida/grafana                 6145fb02ee49        7 days ago          387MB
nexus.ida-analytics.de/ida/moira                   1323d422a434        7 days ago          387MB
busybox                              latest              8c811b4aec35        7 weeks ago         1.15MB
prakhar1989/static-site              latest              f01030e1dcf3        2 years ago         134MB 
</code></pre></div></div><p>این لیست، لیست همه‌ی ایمِج‌هایی هست که من روی این سیستمم نصب دارم و از رجیستری‌های مختلف دریافت کردم. TAG به یک نسخه‌ی مشخص از ایمِج اشاره می‌کنه و IMAGE ID به آی‌دی منحصر به فرد اون ایمِج.<p>برای سادگی فهم، ایمِج‌ها رو به چشم ریپازیتوری‌های گیت ببینید. ایمِج‌ها میتونن کامیت بشن و ورژن‌های مختلفی داشته باشن، در حالت عادی هم، داکر نسخه latest رو دریافت میکنه که مشابه شاخه یا branch اصلی یا main تو گیت هست. مثلا میخوایم یه نسخه از اوبونتو رو دریافت کنیم:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker pull ubuntu:12.04
</code></pre></div></div><p>برای اینکه از یه ایمِج استفاده کنید، یا میتونید اون رو از رجیستری داکر یا همون داکر هاب دریافت کنید یا یه ایمِج برای خودتون بسازید.<p>مهم‌ترین چیزی که باید موقع انتخاب ایمِج‌ها تو ذهن داشته باشید، تفاوت بین ایمِج‌های پایه یا base و ایمِج‌های مبتنی یا child هستن:<ul><li>ایمِج‌های پایه یا <strong>Base images:</strong> ایمِج‌هایی هستند که بر هیچ ایمِج دیگه‌ای مبتنی نیستن، که معمولا (و نه همیشه) سیستم‌عامل هستن، و<li>ایمِج‌های مبتنی یا <strong>Child images:</strong> که مشخصا مبتنی بر ایمج‌های پایه هستن.</ul><p>و دو جور ایمِج رسمی و عیر رسمی هم داریم:<ul><li>ایمِج رسمی یا <strong>Official image:</strong> که توسط خود گروه داکر پشتیبانی و نگهداری میشن. معمولا تک‌کلمه‌ای هستن مثل ubuntu، busybox و hello-world. و<li>ایمِج‌های عیر رسمی یا <strong>Unofficial image:</strong> که توسط کاربرهایی مثل من و شما ساخته میشن و بر اساس ایمِج‌های اصلی هستن که معمولا شکل نمایششون <code class="highlighter-rouge">user-name/image-name</code> هست.</ul><h2 id="اولین-ایمِج-ما">اولین ایمِج ما</h2><p>حالا که درک بهتری از ایمِح‌های داکر داریم، وقتش شده که یه ایمِج برای خودمون بسازیم. برای اینکار، یه برنامه‌ی ساخته شده با <a href="https://www.saidi27.com/%D8%A2%D9%85%D9%88%D8%B2%D8%B4-%D9%86%DA%A9%D8%B3%D8%AA-%D8%AC%DB%8C-%D8%A7%D8%B3-%D8%B1%DB%8C%D8%AF%D8%A7%DA%A9%D8%B3-%D8%AA%D8%A7%D9%86%DA%A9-%D9%88-%DA%A9%D8%A7%D9%86%D9%81%DB%8C%DA%AF-%D9%87%D8%A7">ری‌اکت‌جی‌اس</a> رو اصطلاحا داکرایز یا Dockerize میکنیم:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ npm i -g create-react-app
</code></pre></div></div><p>اول که باید نصاب ری‌اکت رو نصب کنیم، و بعد پروژه رو میسازیم:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ create-react-app our-awesome-app
$ cd our-awesome-app
</code></pre></div></div><p>از اینجا به بعد هر کار خواستید با پروژه بکنید… اما در نهایت یه فایل به اسم <code class="highlighter-rouge">Dockerfile</code> تو پوشه‌ی اصلی پروژه بسازید و اون رو بازش کنید و محتوای زیر رو بهش اضافه کنید:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM node:9.6.1

RUN mkdir /usr/src/app
WORKDIR /usr/src/app

ENV PATH /usr/src/app/node_modules/.bin:$PATH

COPY package.json /usr/src/app/package.json
RUN npm i --silent
RUN npm i react-scripts -g --silent

CMD \["npm", "start"\]
</code></pre></div></div><p>و یه فایل <code class="highlighter-rouge">.dockerignore</code> بسازید (به . اول اسمش دقت کنید) و توش محتوای زیر رو بریزید:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node_modules
</code></pre></div></div><p>و در نهایت ایمِج رو بسازید:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker build -t our-awesome-app .
...
Successfully built 8ab82c09e422
Successfully tagged our-awesome-app:latest
</code></pre></div></div><p>و بعد از اتمام ساخت، کانتینر مربوط به ایمِجتون رو ایجاد و اجرا کنید:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker run -it \
  -v ${PWD}:/usr/src/app \
  -v /usr/src/app/node_modules \
  -p 3000:3000 \
  --rm \
  our-awesome-app
</code></pre></div></div><p>به همین سادگی! شما پروژتون رو داکرایز کردید :) حالا میتونید <a href="http://localhost:3000/">http://localhost:3000</a> رو باز کنید و ببینید پروژتون رو.<h1 id="داکر-کامپُز-docker-compose">داکر کامپُز (Docker Compose)</h1><p>تا اینجا با خود داکر سر و کله زدیم و تا حدودی اکوسیستمش رو شناختیم. منتهی همچنان ابزارهایی هستند که یادگیریشون برامون خیلی پر کاربرد خواهد بود. چندتا از این ابزارهای خوب:<ul><li><a href="https://docs.docker.com/machine/">Docker Machine</a> که کمک میکنه هاست‌های داکر روی کامپیوترتون، کلاد یا فضاهای ابری و حتی دیتا‌سنترتون بسازید،<li><a href="https://docs.docker.com/compose/">Docker Compose</a> ابزاری برای ساخت اپلیکیشن‌های چند کانتینری داکر (چندتا کانتینر رو در کنار هم قرار میده) و<li><a href="https://docs.docker.com/swarm/">Docker Swarm</a> که ابزاری برای ساخت کلاسترها یا خوشه‌های کانتینریه.</ul><p>تو این بخش میخوایم بریم سراغ داکر کامپُز و ببینیم که چطور میشه اپلیکیشن‌های داکر مبتنی بر چند کانتینر ساخت.<p>اینطور فرض کنید که یه کانتینر مسئول اجرای کدهای PHP، Go، JavaScript و زبان‌های دیگست، یه کانتینر دیتابیس MySql و MongoDb رو داره، یه کانتینر وب‌سرور Apache یا NginX و…<p>گذشته‌ی داکر کامپُز جالبه، تقریبا چهار سال پیش (سال ۲۰۱۴) شرکتی به اسم OrchardUp ابزاری رو به اسم Fig به بازار عرضه کرد. هدف از ساخت Fig این بود که بشه محیط برنامه‌نویسی یا Development Environment مبتنی بر داکر ساخت و اونها رو ایزوله کرد، تا فضای کاری برنامه‌نویس‌ها مشابه به هم بشه.<p>تا اینجا، داکر یه ابزاری بود برای ساخت پروسه‌ها یا Application Processes. بعد از این، داکر APIهای مختلفی رو ارائه داد که بشه پوشه‌ها رو بین کانتینرها به اشتراک گذاشت و پورتی رو از هاست به کانتینر فوروارد کرد، لاگ‌ها رو نمایش داد و غیره. ولی با همه‌ی اینها، داکر فقط یه چیز بود: ابزاری برای ساخت پروسه‌ها!<p>با اینکه داکر این امکان رو میده تا بشه کانتینرهای مختلف رو با هم اورکِسترِیت یا Orchestrate کرد (به زبان ساده یعنی هماهنگی بینشون ایجاد کرد تا منظم و درست کار کنن)، همچنان با این کانتینرها به شکل «یک موجودیت» یا Single Entity برخورد نمیکنه. یعنی مهندس نرم‌افزار باید همه‌چیز رو خودش مدیریت کنه. اینجاست که حضور ابزاری مثل Fig خیلی بدرد خورد! از این به بعد مهندسین باید به این شکل بهش نگاه میکردن: «یک برنامه‌ی داکر رو اجرا کنیم که کلاستری از کانتینرها رو مدیریت میکنه» و نه اینکه صرفا یه کانتینر رو اجرا کنیم.<p>مشخص شد که خیلی از بروبچه‌ها و مهندسینی که از داکر استفاده میکردن با این تعریف موافق بودن. برای همین هم وقتی که Fig در حال محبوب شدن بود، شرکت داکر اون رو خرید و اسمش رو به Docker Compose تغییر داد.<p>خب، حالا اصلا کامپُز برای چی استفاده میشه؟ کامپُز یه ابزاره که کمک میکنه برنامه‌هایی رو با چند کانتینر اورکستریت کنیم. این ابزاری فایلی رو ایجاد میکنه به اسم <code class="highlighter-rouge">docker-compose.yml</code> که کل دستوراتی رو که لازم هست رو در خودش داره و اونها رو فقط با یه دستور اجرا میکنه.<p>بذارید با هم برنامه‌ای رو که بالاتر با داکر ساختیم، اینبار با داکر کامپُز اجرا کنیم. برای اینکار فایل <code class="highlighter-rouge">docker-compose.yml</code> تو پوشه‌ی اصلی برنامه بسازید و محتوای زیر رو توش قرار بدید:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: '3.5'

services:

  our-awesome-app:
    container_name: our-awesome-app
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      \- '.:/usr/src/app'
      \- '/usr/src/app/node_modules'
    ports:
      \- '3000:3000'
    environment:
      \- NODE_ENV=development
</code></pre></div></div><p>حالا <a href="https://docs.docker.com/compose/install/">کامپُز رو نصب کنیم</a>…<p>بعد از نصب کامپُز، دستور زیر رو اجرا کنید:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker-compose up -d --build
</code></pre></div></div><p>ساختار داکر کامپُز ——————<p>اصلی‌ترین دلیل ساخت داکر کامپُز، ایجاد برنامه‌ها بر اساس معماری مایکروسرویس بود، یا درواقع کانتینرها و روابط بینشون. اما داکر کامپًز ویژگی‌های دیگه‌ای هم داره:<ul><li>ساخت یک ایمِج داکر (درصورتی که یک فایل <code class="highlighter-rouge">Dockerfile</code> معتبر تو پوشه‌ی اصلی موجود باشه) با دستور:<br /> <code class="highlighter-rouge">docker-compose build</code><li>مقیاس‌بندی کانتینرها با دستور:<br /> <code class="highlighter-rouge">docker-compose scale SERVICE=3</code><li>نجات‌دادن یا درواقع اجرای مجدد کانتینرها در صورت پَنیک با دستور:<br /> <code class="highlighter-rouge">docker-compose up --no-recreate</code></ul><p>یکی از مهم‌ترین دستورات داکر کامپُز، <code class="highlighter-rouge">docker-compose up</code> هست که اول دستور <code class="highlighter-rouge">docker-compose build</code> و بعد <code class="highlighter-rouge">docker-compose run</code> رو اجرا می‌کنه.<h2 id="جریان-کار-یا-workflow-در-داکر-کامپُز">جریان کار یا Workflow در داکر کامپُز</h2><p>جریان کار تو داکر کامپُز سادست:<ol><li>هر سرویس رو تو یه داکر فایل تعریف می‌کنیم (یک روش)،<li>سرویس‌ها و روابطشون رو تو فایل <code class="highlighter-rouge">docker-dompose.yml</code> تعریف می‌کنیم و<li>دستور <code class="highlighter-rouge">docker-compose up</code> رو اجرا می‌کنیم تا سیستم بالا بیاد.</ol><p>اما برای اینکه بهتر متوجه بشیم، میریم که چندتا اپ مختلف بسازیم تا روش‌ها دیگه برای استفاده از داکر کامپُز رو یاد بگیریم<p><a href="https://www.saidi27.com/blog/%D8%AF%D8%A7%DA%A9%D8%B1-%DA%A9%D8%A7%D9%86%D8%AA%DB%8C%D9%86%D8%B1-%D9%88-%D8%A7%D8%AA%D9%88%D9%85%D8%A7%D8%B3%DB%8C%D9%88%D9%86">ادامه‌ی مطلب رو میتونید از سایت خودم بخونید…</a></div><div class="post__share text--center"><ul class="list--unstyled list--inline"><li><a class="button button--with-icon" target="_blank" href="https://twitter.com/intent/tweet?url=/%D8%AF%D8%A7%DA%A9%D8%B1-%DA%A9%D8%A7%D9%86%D8%AA%DB%8C%D9%86%D8%B1-%D9%88-%D8%A7%D8%AA%D9%88%D9%85%D8%A7%D8%B3%DB%8C%D9%88%D9%86/&via=http://pullrequest.ir&text=داکر، داکر کامپز، کانتینرها و اتوماسیون"> <i class="icon pricon-twitter"></i> توییتر </a><li><a class="button button--with-icon" target="_blank" href="https://telegram.me/share/url?url=http://pullrequest.ir/%D8%AF%D8%A7%DA%A9%D8%B1-%DA%A9%D8%A7%D9%86%D8%AA%DB%8C%D9%86%D8%B1-%D9%88-%D8%A7%D8%AA%D9%88%D9%85%D8%A7%D8%B3%DB%8C%D9%88%D9%86/"> <i class="icon pricon-telegram"></i> تلگرام </a></ul></div><script> window.pr.methods.docReady(function() { var singleEntry = window.pr.methods.selectElementByClassName('.post__entry--single'); var excerptEntry = window.pr.methods.selectElementByClassName('.post__excerpt'); if (singleEntry) window.pr.methods.parseTextForEmojis(singleEntry); else if (excerptEntry) window.pr.methods.parseTextForEmojis(excerptEntry); }) </script><hr /><div class="comments"><div id="disqus_thread"></div><script async defer src='https://pwl-rykhwyst.disqus.com/embed.js' onerror="disqusHandler();"></script> <script type="text/javascript"> var disqusHandler = (function (w) { var methods = w.pr.methods; /* methods.docReady(function () { loadDisqusScript() }); function loadDisqusScript() { methods.getAjax('https://pwl-rykhwyst.disqus.com/embed.js', null, function (e) { addDisqusErrorIfNotPresent(); // Parse any emoji inside error methods.parseTextForEmojis(document.getElementById('comment__error')); }) } */ function addDisqusErrorIfNotPresent() { var comments = methods.selectElementByClassName('.comments'); /* Add only for the 1st time */ if (!methods.selectElementById('comment__error')) { /* Add error to .comments */ comments.appendChild(createDisqusError()); /* Parse any emoji inside error */ methods.parseTextForEmojis(document.getElementById('comment__error')); } } function createDisqusError() { var err = document.createElement('div'); err.id = 'comment__error'; window.pr.methods.addClass('alert', err); err.innerHTML = 'اگر این پیام رو میبینین، به این معنیه که اسکریپت Disqus براتون لود نشده. سرویس Disqus توی ایران فیلتر شده!! <strong>لطفا وی پی ان تون رو روشن کنین و صفحه فعلی رو ریفرش کنین.</strong> :پی'; return err; } return addDisqusErrorIfNotPresent; })(window); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></article></div><footer class="site__footer clearfix"><div class="site__footer__brand" onclick="window.pr.methods.goToTop()"> <img class="img-block" src="/assets/images/pr.svg" alt="PR"></div><div class="container clearfix"><nav class="pull-right site__footer__menu"><ul class="list--unstyled list--inline site__footer__list"><li> <a target="_blank" href="https://github.com/pr-techblog"> <i class="icon pricon-github"></i> گیتهاب </a><li> <a target="_blank" href="https://twitter.com/pr_techblog"> <i class="icon pricon-twitter"></i> توییتر </a></ul></nav><div class="pull-left text--ltr site__footer__copyright">Made with ❦ @ <strong>PullRequest</strong></div></div></footer></div><script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-93910742-1', 'auto'); ga('send', 'pageview', { 'page': '/%D8%AF%D8%A7%DA%A9%D8%B1-%DA%A9%D8%A7%D9%86%D8%AA%DB%8C%D9%86%D8%B1-%D9%88-%D8%A7%D8%AA%D9%88%D9%85%D8%A7%D8%B3%DB%8C%D9%88%D9%86/', 'title': 'داکر، داکر کامپز، کانتینرها و اتوماسیون' }); </script>
